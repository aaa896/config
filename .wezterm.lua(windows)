local wezterm = require 'wezterm'
local act = wezterm.action

local config = {}
if wezterm.config_builder then
  config = wezterm.config_builder()
end

-- Inactive pane brightness
config.inactive_pane_hsb = {
  saturation = 1,
  brightness = 1,
}

---------------------------------------------------------------------
-- ENVIRONMENT: ALWAYS START CMD WITH MSVC DEV ENVIRONMENT LOADED
---------------------------------------------------------------------
local dev_env = {
  "cmd.exe",
  "/K",
  "C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\Common7\\Tools\\VsDevCmd.bat",
  "-arch=x64"  
}

config.default_prog = dev_env

---------------------------------------------------------------------
-- Colors, Fonts, UI
---------------------------------------------------------------------
config.window_background_opacity = 1
config.enable_tab_bar = true
config.enable_wayland = false

config.use_fancy_tab_bar = false
config.tab_bar_at_bottom = true

config.color_scheme = 'Edge Dark (base16)'

config.font = wezterm.font_with_fallback {
  'Liberation Mono',
}
config.harfbuzz_features = { 'calt=0', 'clig=0', 'liga=0' }
config.font_size = 9.5
config.tab_max_width = 32
config.show_new_tab_button_in_tab_bar = false

config.window_frame = { font_size = 0.5 }

-------
---
config.colors = {
    split = '#2e282a',

    cursor_bg = "#608277",
--#795151
--#945E57
    --dark #3B2623
    --l2 background= "#82524B",
    --- red background= "#5E3030",
    ---#6C4642
    ---8a5a50
    ---54393a
    --background= "858a7f",
    background= "#211a16",
    --#7d453e

    foreground = '#b08d74',



    tab_bar = {
        -- The color of the strip that goes along the top of the window
        -- (does not apply when fancy tab bar is in use)
        --
        background="#211a16",
        active_tab = {
            -- The color of the background area for the tab
            bg_color = "#608277",
            -- The color of the text for the tab
            fg_color = '#000000',
        },
        inactive_tab = {
            bg_color = "#000000",
            fg_color = '#b08d74',

            -- The same options that were listed under the `active_tab` section above
            -- can also be used for `inactive_tab`.
        },



    },



}
------------------------------------------------------------
-- Function: read Neovim CWD
---------------------------------------------------------------------
local function read_nvim_cwd()
  local f = io.open("/tmp/nvim_cwd", "r")
  if not f then return nil end
  local cwd = f:read("*all")
  f:close()
  return cwd:gsub("\n", "")
end

---------------------------------------------------------------------
-- Sane splits using the SAME environment (keeps cl.exe working)
---------------------------------------------------------------------
local function split_with_env(direction, cwd)
  return act.SplitPane {
    direction = direction,
    cwd = cwd,
    command = {
      args = dev_env,
      cwd = cwd,
    },
  }
end

---------------------------------------------------------------------
-- Spawns a new window with CMD + MSVC env
---------------------------------------------------------------------
local function spawn_with_env(cwd, script)
  return act.SpawnCommandInNewWindow {
    cwd = cwd,
    args = { "cmd.exe", "/K", script },
  }
end

---------------------------------------------------------------------
-- Keybindings
---------------------------------------------------------------------
config.keys = {
  -- Pane navigation
  { key = 'h', mods = 'CTRL|SHIFT', action = act.ActivatePaneDirection('Left') },
  { key = 'j', mods = 'CTRL|SHIFT', action = act.ActivatePaneDirection('Down') },
  { key = 'k', mods = 'CTRL|SHIFT', action = act.ActivatePaneDirection('Up') },
  { key = 'l', mods = 'CTRL|SHIFT', action = act.ActivatePaneDirection('Right') },

  -- Close
  { key = 'w', mods = 'CTRL|SHIFT', action = act.CloseCurrentPane { confirm = true } },

  -- Pane selection
  { key = '2', mods = 'CTRL', action = act.PaneSelect { mode = "MoveToNewTab" } },
  { key = '1', mods = 'CTRL', action = act.PaneSelect { mode = "MoveToNewWindow" } },
  { key = '3', mods = 'CTRL', action = act.PaneSelect { mode = "Activate" } },
  { key = '0', mods = 'CTRL', action = act.PaneSelect { mode = "SwapWithActiveKeepFocus" } },

  -- Split RIGHT %
  {
    key = '%', mods = 'CTRL|SHIFT',
    action = wezterm.action_callback(function(window, pane)
      local cwd = read_nvim_cwd()
      if not cwd then
        window:toast_notification("Error", "Could not read /tmp/nvim_cwd", nil, 5000)
        return
      end
      window:perform_action(split_with_env("Right", cwd), pane)
    end)
  },

  -- Split DOWN "
  {
    key = '"', mods = 'CTRL|SHIFT',
    action = wezterm.action_callback(function(window, pane)
      local cwd = read_nvim_cwd()
      if not cwd then
        window:toast_notification("Error", "Could not read /tmp/nvim_cwd", nil, 5000)
        return
      end
      window:perform_action(split_with_env("Down", cwd), pane)
    end)
  },

  -- ALT+m runs b.sh in new window (for Linux-side scripts)
  {
    key = 'm', mods = 'ALT',
    action = wezterm.action_callback(function(window, pane)
      local cwd = read_nvim_cwd()
      if not cwd then
        window:toast_notification("Error", "Could not read /tmp/nvim_cwd", nil, 5000)
        return
      end
      window:perform_action(act.SpawnCommandInNewWindow {
        cwd = cwd,
        args = { './b.sh' },
      }, pane)
    end),
  },

  -- CTRL+m open MSVC environment + run b.sh via CMD
  {
    key = 'm', mods = 'CTRL',
    action = spawn_with_env(nil, "b.sh"),
  },

  -- Run r.sh from NVIM cwd
  {
    key = 'F5',
    action = wezterm.action_callback(function(window, pane)
      local cwd = read_nvim_cwd()
      if not cwd then
        window:toast_notification("Error", "Could not read /tmp/nvim_cwd", nil, 5000)
        return
      end
      window:perform_action(act.SpawnCommandInNewWindow {
        cwd = cwd,
        args = { './r.sh' },
      }, pane)
    end)
  },

  -- CTRL+F5: run r.sh with the MSVC CMD environment
  {
    key = 'F5', mods = 'CTRL',
    action = spawn_with_env(nil, "r.sh")
  },

  -- Tab movement
  { key = "PageUp", mods = "CTRL|SHIFT", action = act.MoveTabRelative(-1) },
  { key = "PageDown", mods = "CTRL|SHIFT", action = act.MoveTabRelative(1) },
}

return config

